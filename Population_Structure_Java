// Load the Angolan districts shapefile
var districts = ee.FeatureCollection('projects/angolaclimatemeningitis/assets/angola_districts_utf8');

// Load the WorldPop age/sex adjusted population dataset
var dataset = ee.ImageCollection('WorldPop/GP/100m/pop_age_sex_cons_unadj');

// Define visualization parameters
var visualization = {
  bands: ['population'],
  min: 0.0,
  max: 50.0,
  palette: ['24126c', '1fff4f', 'd4ff50']
};

// Center the map on Angola
Map.setCenter(17.87, -11.20, 5); // Adjust coordinates to center on Angola

// Add the population layer to the map
Map.addLayer(dataset.mean(), visualization, 'Population');

// Define age groups and sexes
var ageBands = ['0', '1', '5', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55', '60', '65', '70', '75', '80'];
var sexes = ['M', 'F']; // Male and Female

// Function to calculate population for a specific age and sex band
function calculateBandPopulation(age, sex) {
  var bandName = sex + '_' + age;
  var ageBand = dataset.select(bandName).mean();
  
  var bandResults = districts.map(function(feature) {
    var geometry = feature.geometry();
    var totalPopulation = ageBand.reduceRegion({
      reducer: ee.Reducer.sum(),
      geometry: geometry,
      scale: 100,
      maxPixels: 1e9,
      tileScale: 16  // Add tileScale to reduce the load on the system
    }).get(bandName);
    return feature.set(bandName, totalPopulation);
  });
  
  // Export the results for this specific band
  Export.table.toDrive({
    collection: bandResults,
    description: 'Angola_Districts_' + bandName,
    fileFormat: 'CSV'
  });
  
  // Optionally add the results to the map for visualization
  Map.addLayer(bandResults, {}, 'Districts ' + bandName);
}

// Iterate through each age group and sex to calculate and export
ageBands.forEach(function(age) {
  sexes.forEach(function(sex) {
    calculateBandPopulation(age, sex);
  });
});
